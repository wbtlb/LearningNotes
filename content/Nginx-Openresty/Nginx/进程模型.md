---
title: "进程模型"
date: 2018-07-22T23:49:25+08:00
draft: false
---

### 1. 整体架构

#### 1.1 Nginx 基本架构
    
Nginx和大多数服务器程序一样，会按职责启动不同功能的进程。正常启动后会有多个进程，其中最主要的包括两类进程，一个master_process(主进程)，一个worker_process(工作进程)。其中master进程当监控进程，而由master进程fork()出的子进程来处理具体的业务逻辑。master进程会接受外界发来的信号，并将信号发送给 worker 进程。例如，当worker进程异常退出后，会重新启动新的worker进程。多个worker进程同等竞争请求（Nginx 的惊群现象是个很有意思的问题，我们放到后面详细讨论）。一个请求，只可能在一个 worker 进程中处理。

#### 1.2 Nginx 基本工作流程

master进程会接收到外界发来的各种信号，并且根据信号完成不同的任务，所以控制Nginx只需要向master进程发信号即可。例如，我们如何平滑重启Nginx，保持服务不中断呢？当我们给Nginx发送kill信号后，Nginx会重新加载配置文件，然后启动新的worker进程，然后再向老的worker进程发送信号。此时，新的worker进程开始处理请求，而老的worker进程则停止接收新的请求，并且处理完当前已接收到的请求后，便会退出。

worker进程之间是平等的，每个连接请求进来后，每个进程都可能处理这个请求。其中，每个worker进程都是由master进程fork出来的，在master进程中，首先要建立好需要监听的socket（listenfd拿到文件描述符）之后，之后再创建出多个worker进程。所有worker进程的listenfd会在连接到来时变得可读，为了保证只有一个进程处理一个请求，所有worker进程在注册listenfd读事件前竞争accept_mutex。拿到互斥锁的 worker 进程才有资格处理这个请求（这里要提一下 Nginx 惊群现象，我们后面细聊）。处理完请求后返回给客户端，最后断开连接，这就是一个请求的过程。




### 进程通信

### 共享内存

### slab 机制

### 信号处理
